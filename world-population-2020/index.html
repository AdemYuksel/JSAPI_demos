<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>World population</title>
  <link rel="stylesheet" href="https://js.arcgis.com/4.8/esri/css/main.css">
  <link rel="stylesheet" href="css/nouislider.min.css">
  <link rel="stylesheet" href="css/main.css">
  <script>
    var locationPath = location.pathname.replace(/\/[^\/]+$/, '');
    window.dojoConfig = {
      packages: [{
        name: 'nouislider',
        location: locationPath + 'app',
        main: 'nouislider.min'
      }, {
        name: 'utils',
        location: locationPath + 'app',
        main: 'utils'
      }]
    };

  </script>
  <script src="https://js.arcgis.com/4.8/"></script>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans+Condensed:300" rel="stylesheet">

  <script>
    require([
      "esri/layers/FeatureLayer",
      "esri/layers/TileLayer",
      "esri/Map",
      "esri/views/SceneView",
      "esri/renderers/SimpleRenderer",
      "esri/symbols/PointSymbol3D",
      "esri/symbols/ObjectSymbol3DLayer",
      "esri/widgets/Legend",
      "esri/core/watchUtils",
      "dojo/Deferred",
      "utils",
      "esri/renderers/smartMapping/statistics/summaryStatistics",
      "dojo/domReady!"
    ], function (
      FeatureLayer,
      MapImageLayer,
      Map, SceneView,
      SimpleRenderer,
      PointSymbol3D,
      ObjectSymbol3DLayer,
      Legend,
      watchUtils,
      Deferred,
      utils,
      summaryStatistics
    ) {


        var colorStops = [
          {
            value: 10,
            color: [83, 0, 244]
          },
          {
            value: 400000,
            color: [4, 245, 248]
          },
          {
            value: 7000000,
            color: [4, 245, 248]
          },
          {
            value: 30000000,
            color: [4, 245, 248]
          }
        ];


        // renderer for the population layer
        var renderer = new SimpleRenderer({
          symbol: new PointSymbol3D({
            symbolLayers: [new ObjectSymbol3DLayer({
              resource: {
                primitive: "cube"
              },
              material: {
                color: "#00E9FF"
              },
              anchor: "bottom",
              width: 60000,
              depth: 60000,
              height: 60000
            })]
          })
        });

        const populationLayer = new FeatureLayer({
          url: "https://services2.arcgis.com/cFEFS0EWrhfDeVw9/arcgis/rest/services/World_population_count_2020/FeatureServer",
          definitionExpression: "population_count > 10",
          renderer: renderer
        })

        var graticule = new FeatureLayer({
          url: "https://services.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/World_graticule_15deg/FeatureServer",
          renderer: {
            type: "simple",
            symbol: {
              type: "line-3d",
              symbolLayers: [{
                type: "line",
                material: {
                  color: "#00E9FF"
                }
              }]
            }
          },
          opacity: 0.3
        });

        var countryBoundaries = new FeatureLayer({
          url: "http://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/World_Countries_(Generalized)/FeatureServer",
          title: "World Countries",
          renderer: {
            type: "simple",
            symbol: {
              type: "polygon-3d",
              symbolLayers: [{
                type: "fill",  // autocasts as new FillSymbol3DLayer()
                material: { color: [255, 250, 239, 0] },
                outline: {
                  color: "#00E9FF",
                  size: 2
                },
              }]
            }
          }
        });
      
        var map = new Map({
          layers: [graticule, populationLayer, countryBoundaries],
          ground: {
            surfaceColor: [5, 50, 56],
            opacity: 0.7
          }
        });


        // set the environment
        var view = new SceneView({
          map: map,
          container: "viewDiv",
          constraints: {
            collision: {
              enabled: true
            }
          },
          camera: {
            position: {
              spatialReference: {
                latestWkid: 4326,
                wkid: 4326
              },
              x: -120.45651418690257,
              y: 20.813251923155075,
              z: 23057115
            },
            heading: 0,
            tilt: 0
          },
          padding: {
            bottom: 200
          },
          ui: {
            components: []
          },
          environment: {
            background: {
              type: "color",
              color: [5, 50, 56]
            },
            atmosphereEnabled: false,
            starsEnabled: false,
            lighting: {
              directShadowsEnabled: true,
              date: new Date("Sun Jul 15 2018 23:47:59 GMT+0200 (Central European Summer Time)"),
              cameraTrackingEnabled: true,
              ambientOcclusionEnabled: true
            }
          }
        });
        window.view = view;

        summaryStatistics({
            layer: populationLayer,
            field: "population_count"
          })
          .then((result) => {
            console.log(result);
            const slider = utils.createSlider(10, 1000000);

            slider.on('end', function (values) {
              const min = parseInt(values[0].replace(" persons/unit", ""));
              const value1 = parseInt(values[1].replace(" persons/unit", ""));
              console.log(min);
              const max = (value1 >= 1000000) ? result.max : value1;
              populationLayer.definitionExpression =
                `population_count >= ${min} AND population_count <= ${max}`;
            });
          })
          .otherwise((err) => {
            console.log(err);
          });

        

      });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
  <footer>
    <h1>World population in 2020</h1>
    <p>World population count estimate for 2020 as a grid. Each grid unit is equivalent to aproximatively 110km.
      Use the slider to filter cells based on the number of persons per grid unit.
    </p>
    <div id="populationSlider"></div>
    <span class="credits">Original population raster data from 
      <a href="http://sedac.ciesin.columbia.edu/data/set/gpw-v4-population-count-rev10/data-download" target="_blank">SEDAC</a>.
      This prototype was built with <a href="https://developers.arcgis.com/javascript/" target="_blank">ArcGIS API for JavaScript</a>.
      The full code and a tutorial on how to build this app live on <a href="https://github.com/RalucaNicola/JSAPI_demos/tree/master/world-population-2020" target="_blank">Github</a>.
    </span>
  </footer>
</body>

</html>